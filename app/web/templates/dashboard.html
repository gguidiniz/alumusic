<!DOCTYPE html>
<html lang="pt-br" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AluMusic - Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"/>
</head>
<body>
    <main class="container">
        <nav>
            <ul>
                <li><strong>AluMusic Dashboard</strong></li>
            </ul>
            <ul>
                <li><a href="{{ url_for('main.weekly_report') }}" target="_blank">Relatório Público</a></li>
                <li><a href="{{ url_for('main.export_csv') }}" role="button" class="secondary">Exportar CSV</a></li>
                <li><a href="{{ url_for('main.logout') }}" role="button" class="contrast">Logout</a></li>
            </ul>
        </nav>

        <hgroup>
            <h2>Últimos Comentários Recebidos</h2>
            <p>Visualizando os comentários e suas classificações mais recentes.</p>
        </hgroup>
        
        <form action="{{ url_for('main.dashboard_page') }}" method="GET">
            <div class="grid" style="grid-template-columns: 1fr auto auto; gap: 0.5rem;">
                <input type="search" id="search" name="q" placeholder="Buscar por palavra-chave..." value="{{ search_term or '' }}" style="margin-bottom: 0;">
                {% if search_term %}
                    <a href="{{ url_for('main.dashboard_page') }}" role="button" class="secondary" style="margin-bottom: 0;">Limpar Busca</a>
                {% endif %}
                <button type="submit" style="margin-bottom: 0;">Buscar</button>
            </div>
        </form>

        <figure>
            <table>
                <thead>
                    <tr>
                        <th scope="col">Data</th>
                        <th scope="col">Comentário</th>
                        <th scope="col">Categoria</th>
                        <th scope="col">Tags</th>
                    </tr>
                </thead>
                <tbody>
                    {% for comment in pagination.items %}
                    <tr>
                        <td>{{ comment.created_at | localdatetime }}</td>
                        <td>{{ comment.text }}</td>
                        {% if comment.classifications %}
                            {% set latest_classification = comment.classifications[-1] %}
                            <td>
                                <span title="Confiança: {{ latest_classification.confidence|round(2) }}">
                                    {{ latest_classification.category }}
                                </span>
                            </td>
                            <td>
                                {% for tag in latest_classification.tags %}
                                    <ins>{{ tag.name }}</ins>&nbsp;
                                {% endfor %}
                            </td>
                        {% else %}
                            <td colspan="2"><em>Ainda não classificado.</em></td>
                        {% endif %}
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">Nenhum comentário encontrado.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </figure>

        <footer>
            <nav>
                <ul>
                    {% if pagination.has_prev %}
                        <li><a href="{{ url_for('main.dashboard_page', page=pagination.prev_num, q=search_term or None) }}">Página Anterior</a></li>
                    {% endif %}
                </ul>
                <ul>
                    {% if pagination.pages > 1 %}
                        <li>Página {{ pagination.page }} de {{ pagination.pages }}.</li>
                    {% endif %}
                </ul>
                <ul>
                    {% if pagination.has_next %}
                        <li><a href="{{ url_for('main.dashboard_page', page=pagination.next_num, q=search_term or None) }}">Próxima Página</a></li>
                    {% endif %}
                </ul>
            </nav>
        </footer>
    </main>
</body>
</html>